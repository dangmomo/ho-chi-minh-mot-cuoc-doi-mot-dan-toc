import React, { useState, useRef, useEffect } from 'react';
import { TimelineEvent } from '../types';
import { Quote, Calendar, Star, ChevronDown, ChevronUp } from 'lucide-react';

interface Props {
    event: TimelineEvent;
    isEven: boolean;
}

export const VintageCard: React.FC<Props> = ({ event, isEven }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const [isVisible, setIsVisible] = useState(false);
    const cardRef = useRef<HTMLDivElement>(null);

    useEffect(() => {
        const observer = new IntersectionObserver(
            ([entry]) => {
                if (entry.isIntersecting) {
                    setIsVisible(true);
                    observer.disconnect(); // Only animate once
                }
            },
            { threshold: 0.15, rootMargin: '0px 0px -50px 0px' }
        );

        if (cardRef.current) {
            observer.observe(cardRef.current);
        }

        return () => observer.disconnect();
    }, []);

    const toggleExpand = () => {
        setIsExpanded(!isExpanded);
    };

    return (
        <div 
            ref={cardRef}
            className={`relative flex flex-col md:flex-row ${isEven ? 'md:flex-row-reverse' : ''} gap-6 items-start mb-16 group transition-all duration-1000 ease-out transform ${isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-16'}`}
        >
            
            {/* Timeline Dot & Connector */}
            <div className="absolute left-1/2 -translate-x-1/2 h-full w-0.5 bg-vintage-gold/50 hidden md:block -z-10 top-0"></div>
            <div className="absolute left-1/2 -translate-x-1/2 w-8 h-8 rounded-full border-4 border-vintage-paper bg-vintage-red shadow-lg hidden md:flex items-center justify-center z-10 top-0 sticky-dot transition-transform duration-300 hover:scale-125">
                <Star size={14} className="text-vintage-gold fill-vintage-gold" />
            </div>

            {/* Date Badge (Mobile) */}
            <div className="md:hidden w-full flex items-center gap-2 mb-2">
                 <div className="bg-vintage-red text-vintage-paper px-3 py-1 rounded text-sm font-bold font-serif flex items-center gap-2 shadow-sm">
                    <Calendar size={14} /> {event.year}
                 </div>
            </div>

            {/* Content Box */}
            <div className={`w-full md:w-1/2 ${isEven ? 'md:pl-12' : 'md:pr-12'}`}>
                <div className={`bg-[#f9f5ea] p-6 rounded-sm shadow-md border border-vintage-gold/30 relative overflow-hidden transition-all duration-300 hover:shadow-xl group-hover:border-vintage-gold ${isExpanded ? 'ring-2 ring-vintage-gold/20' : ''}`}>
                    {/* Paper Texture Overlay */}
                    <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')] pointer-events-none"></div>
                    
                    {/* Corner Decoration */}
                    <div className="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-vintage-red/30"></div>
                    <div className="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-vintage-red/30"></div>

                    {/* Header */}
                    <div className="hidden md:flex items-center gap-2 mb-3 text-vintage-red font-bold font-serif border-b border-vintage-gold/20 pb-2">
                        <Calendar size={16} />
                        <span>{event.year}</span>
                    </div>

                    <h3 className="text-2xl font-serif font-bold text-vintage-dark mb-3 leading-tight">{event.title}</h3>
                    
                    {/* Summary Description */}
                    <div className="font-body text-vintage-dark/80 leading-relaxed mb-4 text-justify drop-cap">
                        {event.description}
                    </div>

                    {/* Full Text - Expandable Section */}
                    <div className={`transition-all duration-700 ease-in-out overflow-hidden ${isExpanded ? 'max-h-[2000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                        {event.fullText && (
                            <div className="mt-4 pt-4 border-t border-vintage-dark/10 space-y-3">
                                {event.fullText.map((paragraph, idx) => (
                                    <p key={idx} className="font-body text-vintage-dark/90 text-justify leading-relaxed text-sm md:text-base indent-6">
                                        {paragraph}
                                    </p>
                                ))}
                            </div>
                        )}
                        
                        {event.details && (
                             <ul className="space-y-2 mt-4 pl-2 border-t border-vintage-dark/5 pt-2">
                                {event.details.map((detail, idx) => (
                                    <li key={idx} className="flex items-start gap-2 text-sm text-vintage-dark/70 font-body italic">
                                        <span className="mt-1.5 w-1.5 h-1.5 rounded-full bg-vintage-red flex-shrink-0"></span>
                                        {detail}
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>

                    {/* Quote - Always visible if present, but moved down if expanded */}
                    {event.quote && (
                        <div className="mt-6 mb-2 pl-4 border-l-4 border-vintage-gold bg-vintage-gold/10 p-4 rounded-r italic font-serif text-lg text-vintage-dark/90 relative">
                            <Quote size={20} className="absolute -top-2 -left-2 text-vintage-gold fill-vintage-gold" />
                            "{event.quote}"
                        </div>
                    )}

                    {/* Expand/Collapse Button */}
                    {(event.fullText || event.details) && (
                        <button 
                            onClick={toggleExpand}
                            className="mt-4 flex items-center gap-2 text-vintage-red font-bold text-sm uppercase tracking-wide hover:underline hover:text-red-800 transition-colors mx-auto md:mx-0 group-hover:translate-x-1 duration-300"
                        >
                            {isExpanded ? (
                                <>Thu gọn <ChevronUp size={16} /></>
                            ) : (
                                <>Đọc thêm chi tiết <ChevronDown size={16} /></>
                            )}
                        </button>
                    )}
                </div>
            </div>

            {/* Image Box */}
            <div className={`w-full md:w-1/2 ${isEven ? 'md:pr-12' : 'md:pl-12'} flex justify-center sticky top-24 self-start`}>
                {event.image ? (
                    <div className="relative p-2 bg-white shadow-lg rotate-1 transition-transform duration-500 hover:rotate-0 max-w-sm group-hover:scale-105">
                        <div className="absolute top-[-10px] left-1/2 -translate-x-1/2 w-24 h-6 bg-vintage-gold/20 backdrop-blur-sm transform -rotate-1 shadow-sm border border-white/50 z-10"></div>
                        <img 
                            src={event.image} 
                            alt={event.title}
                            className="w-[400px] h-[250px] object-cover sepia-[.3] hover:sepia-0 transition-all duration-700"
                            // className="w-full h-auto sepia-[.3] hover:sepia-0 transition-all duration-700"
                        />
                        <div className="pt-2 text-center font-script text-vintage-dark/60 text-lg">
                            {event.title}
                        </div>
                    </div>
                ) : (
                    <div className="hidden md:flex items-center justify-center h-full opacity-10">
                         <div className="w-32 h-1 bg-vintage-dark"></div>
                    </div>
                )}
            </div>
        </div>
    );
};